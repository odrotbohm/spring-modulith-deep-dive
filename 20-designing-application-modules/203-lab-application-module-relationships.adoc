[[module-design.relationships]]
= 🧑‍💻 Establishing relationships between modules

[[module-design.relationships.objectives]]
== 🎯 Objectives

You'll learn how to…

* … establish relationships between modules via Spring bean references
* … detect invalid dependencies via a JUnit-based architectural fitness function

[[module-design.relationships.managing-type-relationships]]
== 👣 Managing type relationships

. Create an application module package `inventory`.
. Add an application service `Inventory` inside that package.
ifndef::educates[]
+
[source, java]
----
package com.example.app.inventory;

import lombok.RequiredArgsConstructor;

import org.springframework.stereotype.Component;

@Component
@RequiredArgsConstructor
public class Inventory {
}
----
endif::[]

. Run modularity tests.

ifdef::educates[]
[source, section:begin]
----
title: "Expand for clickable instructions"
----
[source, terminal:execute]
----
prefix: Editor
title: "Create inventory module and Inventory class"
command: "mkdir -p src/main/java/com/example/app/inventory && cat /dev/null > src/main/java/com/example/app/inventory/Inventory.java"
cascade: true
description: |
    package com.example.app.inventory;

    import lombok.RequiredArgsConstructor;

    import org.springframework.stereotype.Component;

    @Component
    @RequiredArgsConstructor
    public class Inventory {
    }
----
[source, dashboard:reload-dashboard]
----
name: Editor
cascade: true
hidden: true
----
[source, editor:append-lines-to-file]
----
hidden: true
file: ~/exercises/src/main/java/com/example/app/inventory/Inventory.java
text: |
    package com.example.app.inventory;

    import lombok.RequiredArgsConstructor;

    import org.springframework.stereotype.Component;

    @Component
    @RequiredArgsConstructor
    public class Inventory {
    }
----
[source, terminal:execute]
----
title: "Run test"
command: mvnw test
----
[source, section:end]
----
----
endif::[]

Examine the output. You should see the new module listed, including the `Inventory` component.
ifndef::educates[]
+
endif::[]
[source, text]
----
# Inventory
> Logical name: inventory
> Base package: com.example.app.inventory
> Direct module dependencies: none
> Spring beans:
  + ….Inventory

# Order
> Logical name: order
> Base package: com.example.app.order
> Direct module dependencies: none
> Spring beans:
  + ….OrderManagement
  o ….persistence.OrderRepository
----

. In `OrderManagement` add a dependency to the Inventory.
ifndef::educates[]
+
[source, java]
----
package com.example.app.order;

import lombok.RequiredArgsConstructor;

import org.springframework.stereotype.Component;

import com.example.app.inventory.Inventory;

@Component
@RequiredArgsConstructor
public class OrderManagement {

	private final Inventory inventory;
}
----
endif::[]

. Run the modularity tests.

ifdef::educates[]
[source, section:begin]
----
title: "Expand for clickable instructions"
----
[source, editor:select-matching-text]
----
title: "Add a reference to Inventory in OrderManagement"
file: ~/exercises/src/main/java/com/example/app/order/OrderManagement.java
text: "class OrderManagement"
before: 2
after: 0
cascade: true
description: |
    package com.example.app.order;

    import lombok.RequiredArgsConstructor;

    import org.springframework.stereotype.Component;

    import com.example.app.inventory.Inventory;

    @Component
    @RequiredArgsConstructor
    public class OrderManagement {

        private final Inventory inventory;
    }
----
[source,editor:replace-text-selection]
----
hidden: true
file: ~/exercises/src/main/java/com/example/app/order/OrderManagement.java
text: |
    import com.example.app.inventory.Inventory;

    @Component
    @RequiredArgsConstructor
    public class OrderManagement {

        private final Inventory inventory;
----
[source, terminal:execute]
----
title: "Run test"
command: mvnw test
----
[source, section:end]
----
----
endif::[]

Examine the output. Note that the model now reflects the cross-application-module dependency we introduced.
ifndef::educates[]
+
endif::[]
[source, text]
----
# Order
> Logical name: order
> Base package: com.example.app.order
> Direct module dependencies: inventory
> Spring beans:
  + ….OrderManagement
  o ….persistence.OrderRepository
----

. Introduce a dependency from the `Inventory` to the `OrderManagement`.
ifndef::educates[]
+
[source, java]
----
package com.example.app.inventory;

import lombok.RequiredArgsConstructor;

import org.springframework.stereotype.Component;

import com.example.app.order.OrderManagement;

@Component
@RequiredArgsConstructor
public class Inventory {

	private final OrderManagement orders;
}
----
endif::[]

. Re-run the modularity test.

ifdef::educates[]
[source, section:begin]
----
title: "Expand for clickable instructions"
----
[source, editor:select-matching-text]
----
title: "Add a reference to OrderManagement in Inventory"
file: ~/exercises/src/main/java/com/example/app/inventory/Inventory.java
text: "class Inventory"
before: 2
after: 0
cascade: true
description: |
    package com.example.app.inventory;

    import lombok.RequiredArgsConstructor;

    import org.springframework.stereotype.Component;

    import com.example.app.order.OrderManagement;

    @Component
    @RequiredArgsConstructor
    public class Inventory {

        private final OrderManagement orders;
    }
----
[source,editor:replace-text-selection]
----
hidden: true
file: ~/exercises/src/main/java/com/example/app/inventory/Inventory.java
text: |
    import com.example.app.order.OrderManagement;

    @Component
    @RequiredArgsConstructor
    public class Inventory {

        private final OrderManagement orders;
----
[source, terminal:execute]
----
title: "Run test"
command: mvnw test
----
[source, section:end]
----
----
endif::[]

Examine the output. You should see the test fail because of the cyclic dependency.
This is another example of how Spring Modulith enhances compilation checks over and above the capabilities of the Java compiler.
ifndef::educates[]
+
endif::[]
[source, text]
----
[INFO] -------------------------------------------------------
[INFO]  T E S T S
[INFO] -------------------------------------------------------
[INFO] Running com.example.app.ApplicationModularityTests
02:39:18.818 [main] INFO com.tngtech.archunit.core.PluginLoader -- Detected Java version 21.0.1
[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 0.726 s <<< FAILURE! -- in com.example.app.ApplicationModularityTests
[ERROR] com.example.app.ApplicationModularityTests.bootstrapsApplicationModules -- Time elapsed: 0.711 s <<< ERROR!
org.springframework.modulith.core.Violations:
- Cycle detected: Slice inventory ->
                Slice order ->
                Slice inventory
  1. Dependencies of Slice inventory
    - Constructor <com.example.app.inventory.Inventory.<init>(com.example.app.order.OrderManagement)> has parameter of type <com.example.app.order.OrderManagement> in (Inventory.java:0)
    - Field <com.example.app.inventory.Inventory.orders> has type <com.example.app.order.OrderManagement> in (Inventory.java:0)
  2. Dependencies of Slice order
    - Constructor <com.example.app.order.OrderManagement.<init>(com.example.app.inventory.Inventory, com.example.app.order.persistence.OrderRepository)> has parameter of type <com.example.app.inventory.Inventory> in (OrderManagement.java:0)
    - Field <com.example.app.order.OrderManagement.inventory> has type <com.example.app.inventory.Inventory> in (OrderManagement.java:0)
----
